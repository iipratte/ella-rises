<!DOCTYPE html>
<html lang="en">
<head>
    <title>Survey Responses - Ella Rises</title>
    <%- include('../partials/head') %> 
    <style>
        /* Click to Expand Logic */
        .comment-cell {
            max-width: 250px;
            cursor: pointer;
            position: relative;
        }
        
        /* Default State: Truncated */
        .comment-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        
        /* Expanded State: Full Text */
        .comment-text.expanded {
            white-space: normal;
            overflow: visible;
        }

        /* Hover Effect to show it's clickable */
        .comment-cell:hover .comment-text {
            color: var(--er-primary-dark);
        }
    </style>
</head>
<body class="bg-light">

    <%- include('../partials/header') %>

    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-primary fw-bold" style="font-family: 'DM Serif Display', serif;">Survey Responses</h1>
                <p class="text-muted">Feedback submitted by participants after events.</p>
            </div>
        </div>

        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-4">Event Name</th>
                                <th>Event Date</th> 
                                <th>Participant</th>
                                <th class="text-center">Sat.</th>
                                <th class="text-center">Use.</th>
                                <th>NPS Bucket</th>
                                <th>Comments</th>
                                <% if (user && user.role === 'Manager') { %>
                                    <th class="text-end pe-4">Actions</th>
                                <% } %>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (responses.length === 0) { %>
                                <tr><td colspan="8" class="text-center py-5 text-muted">No responses received yet.</td></tr>
                            <% } else { %>
                                <% responses.forEach(r => { %>
                                    <tr>
                                        <td class="ps-4 fw-bold text-dark">
                                            <%= r.event_name %>
                                        </td>
                                        
                                        <td class="text-muted small">
                                            <%= new Date(r.eventdatetimestart).toLocaleDateString() %>
                                        </td>

                                        <td class="text-primary fw-bold">
                                            <%= r.participantfirstname %> <%= r.participantlastname %>
                                        </td>

                                        <td class="text-center">
                                            <% let badgeClass = 'bg-secondary'; %>
                                            <% if (r.satisfaction_score >= 5) badgeClass = 'bg-success'; %>
                                            <% if (r.satisfaction_score <= 3) badgeClass = 'bg-danger'; %>
                                            <span class="badge <%= badgeClass %>"><%= r.satisfaction_score %>/5</span>
                                        </td>

                                        <td class="text-center"><%= r.usefulness_score || '-' %>/5</td>
                                        
                                        <td>
                                            <% if (r.surveynpsbucket === 'Promoter') { %>
                                                <span class="badge bg-success bg-opacity-25 text-success border border-success">Promoter</span>
                                            <% } else if (r.surveynpsbucket === 'Detractor') { %>
                                                <span class="badge bg-danger bg-opacity-25 text-danger border border-danger">Detractor</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary">Passive</span>
                                            <% } %>
                                        </td>

                                        <td class="comment-cell" onclick="toggleComment(this)">
                                            <span class="comment-text text-muted small fst-italic">
                                                <%= r.comments || '-' %>
                                            </span>
                                        </td>

                                        <% if (user && user.role === 'Manager') { %>
                                            <td class="text-end pe-4">
                                                <div class="d-flex justify-content-end gap-2">
                                                    <a href="/survey/edit/<%= r.surveyid %>" class="btn btn-sm btn-outline-secondary rounded-circle" title="Edit" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                                        <i class="bi bi-pencil-fill"></i>
                                                    </a>
                                                    <form action="/survey/delete/<%= r.surveyid %>" method="POST" class="d-inline" onsubmit="return confirm('Delete this survey?');">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger rounded-circle" title="Delete" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                                            <i class="bi bi-trash-fill"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        <% } %>
                                    </tr>
                                <% }) %>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-muted small py-3">
                Showing <%= responses.length %> response(s)
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toggle class to expand/collapse comment
        function toggleComment(cell) {
            const span = cell.querySelector('.comment-text');
            span.classList.toggle('expanded');
        }
    </script>
</body>
</html>